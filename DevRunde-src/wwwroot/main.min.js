function log(n){$("#log").append(n+"<br/>")}function initPage(){try{$("body").show();var n=window.authContext.getCachedUser();log("user:"+n);n?(showUserInfo(n),window.authContext.acquireToken(window.authConfig.endpoints.graph,function(n,t){window.localStorage.setItem("graphToken",t);t||authenticateFailed("Acquring Graph Token Failed: "+n)}),$("#embed").show()):cleanPage()}catch(t){log(t)}}function authenticate(n){microsoftTeams.authentication.authenticate({url:n,width:500,height:700,successCallback:authenticateSucceeded,failureCallback:authenticateFailed})}function authenticateSucceeded(n){if($("body").show(),n){window.localStorage.setItem("graphToken",n);var t=window.authContext.getCachedUser();showUserInfo(t);getData()}else cleanPage()}function authenticateFailed(n){$("#message").append("<div>"+n+"<\/div>");typeof n=="string"&&(n.indexOf("Login Failed:")===0?$("#message").append("<div>Please check your account and Log In again.<\/div>"):n.indexOf("Acquring Graph Token Failed:")===0&&$("#message").append("<div>Please try Log Out and Log In again.<\/div>"))}function logOut(){window.authContext.clearCache();window.authContext._user=null;window.authContext._loginInProgress=!1;var n="post_logout_redirect_uri="+encodeURIComponent(window.authContext.config.postLogoutRedirectUri),t=window.authContext.instance+window.authContext.config.tenant+"/oauth2/logout?"+n;microsoftTeams.authentication.authenticate({url:t,width:400,height:600,successCallback:authenticateSucceeded})}function login(){try{window.authContext._loginInProgress=!1;window.authContext.login()}catch(n){log(n)}}function cleanPage(){showUserInfo();$("#docBin").empty();$("#inventoryBin").empty();showDetailsPage(!1)}function showDetailsPage(n){$("#detailsPage").toggle(n);$("#inventoryPage").toggle(!n)}function showUserInfo(n){var t=typeof n!="undefined"&&n!==null,i=t?n.profile.name:"";window.localStorage.setItem("userName",i);$("#signedInAsLabel").toggle(t);$(".app-signIn").toggle(!t);$(".app-signOut").toggle(t)}function showBike(){var n=$(this).data("bike");n&&(n.fields.Picture!==null&&$("#bikeImage").css("background-image","url('"+n.fields.Picture.Url+"')"),$("#bikeTitle").text(n.fields.Title+" "+n.fields.Serial),$("#bikeDescription").html(n.fields.Description),$("#bikeDetailsPrice").text(n.fields.Price+" / day"),$("#bikeDetailsLocation").text(n.fields.Location),$("#bikeDetailsCondition").text(n.fields.Condition),$("#detailsPage").data("bike",n),showDetailsPage(!0))}function bikeAction(){var n=$(this),t;n.hasClass("wait")||(t=n.hasClass("checkOut"),n.removeClass("checkOut checkIn").addClass("wait"),window.setTimeout(bikeActionCompleted.bind(n,t),1200))}function bikeActionCompleted(n){this.removeClass("wait").addClass(n?"checkIn":"checkOut");this.closest("#detailsPage").data("lastAction",n?"checked out":"checked in")}function getData(){acquireSiteId(function(){acquireListIds(function(){retrieveBikes();retrieveDocs()})})}function retrieveDocs(){var i=getGraphToken(),n=getSiteId(),t=getListId(window.appConfig.documentLibrary);i&&n&&t&&$.ajax({type:"GET",url:window.authConfig.endpoints.graph+"/v1.0/sites/"+n+"/lists/"+t+"/items?expand=columnSet",dataType:"json",headers:{Authorization:"Bearer "+getGraphToken(),Accept:"application/json"}}).done(function(n){for(var i=n.value,t=0;t<i.length;t++){var r=i[t],o=getFileNameWithoutExtension(r.fields.LinkFilename),u=$("<a target='_blank'>").attr("href",r.webUrl+"?web=1").addClass("docTile ms-font-m"),f=$("<div>"),e=$("<div class='docTileContent'>").appendTo(f),s=$("<div class='docTileText'>").text(o).appendTo(e),h=$("<div class='docTileIcon'><i class='ms-Icon ms-Icon--WordLogo'><\/i><\/div>").appendTo(e);u.html(f);$("#docBin").append(u)}}).fail(function(n){$("#message").html("Web Request Failed: "+n.responseText)})}function retrieveBikes(){var n=getGraphToken(),t=getSiteId(),i=getListId(window.appConfig.list);n&&t&&i&&$.ajax({type:"GET",url:window.authConfig.endpoints.graph+"/v1.0/sites/"+t+"/lists/"+i+"/items?expand=columnSet",dataType:"json",headers:{Authorization:"Bearer "+n,Accept:"application/json"}}).done(function(n){for(var i,l,r,e,o=n.value,u=0;u<o.length;u++){var t=o[u],s=$("<div class='itemTile ms-font-m'>").data("bike",t),f=$("<div>"),c=$("<div class='itemTileImage'>").appendTo(f);if(t.fields.Picture!==null&&c.css("background-image","url('"+t.fields.Picture.Url+"')"),i=$("<div class='itemTileContent'>").appendTo(f),l=$("<div class='itemTileText'>").text(t.fields.Title+" "+t.fields.Serial).appendTo(i),t.fields.Color_x0020_Swatch!==null)var h=$("<div class='itemColorArea'>").appendTo(i),a=$("<div class='itemColorSwatch'>").css("background-color",t.fields.Color_x0020_Swatch).appendTo(h),v=$("<div class='itemColorTitle'>").text(t.fields.Color_x0020_Scheme).appendTo(h);t.fields.Price!==null&&(r=$("<div class='itemFieldArea'>").appendTo(i),r.append("<div class='itemFieldLabel'>Price<\/div>"),$("<div class='itemFieldValue'>").text(t.fields.Price).appendTo(r),r.append("<span> / day<\/span>"));t.fields.Location!==null&&(e=$("<div class='itemFieldArea'>").appendTo(i),e.append("<div class='itemFieldLabel'>Location<\/div>"),$("<div class='itemFieldValue'>").text(t.fields.Location).appendTo(e));s.html(f).click(showBike);$("#inventoryBin").append(s)}}).fail(function(n){$("#message").html("Web Request Failed: "+n.responseText)})}function acquireSiteId(n){var t=getGraphToken();t&&$.ajax({type:"GET",url:window.authConfig.endpoints.graph+"/v1.0/sites/"+window.appConfig.siteHost+(window.appConfig.siteUrl?":"+window.appConfig.siteUrl:""),dataType:"json",headers:{Authorization:"Bearer "+t,Accept:"application/json"}}).done(function(t){window.localStorage.setItem("siteId",t.id);n()})}function acquireListIds(n){var t=getSiteId();t&&$.ajax({type:"GET",url:window.authConfig.endpoints.graph+"/v1.0/sites/"+t+"/lists",dataType:"json",headers:{Authorization:"Bearer "+getGraphToken(),Accept:"application/json"}}).done(function(t){var i=t.value,r=findListId(i,window.appConfig.list);window.localStorage.setItem(window.appConfig.list,findListId(i,window.appConfig.list));window.localStorage.setItem(window.appConfig.documentLibrary,findListId(i,window.appConfig.documentLibrary));n()})}function findListId(n,t){var r,i;for(r in n)if(i=n[r],i.name===t)return i.id;return null}function getGraphToken(){return window.localStorage.getItem("graphToken")}function getSiteId(){return window.localStorage.getItem("siteId")}function getListId(n){return window.localStorage.getItem(n)}function getUserName(){return window.localStorage.getItem("userName")}function getFileNameWithoutExtension(n){var t=n.indexOf(".");return t>0?n.substring(0,t):n}microsoftTeams.initialize();$(document).ready(function(){log("ready");try{if(window.authConfig={tenant:"MSDNKnowledgeManagementaleg.onmicrosoft.com",clientId:"eaf47017-07ad-48c3-9443-74a10e156b9c",redirectUri:"https://devrunde.azurewebsites.net/",postLogoutRedirectUri:"https://devrunde.azurewebsites.net/logout.html",endpoints:{graph:"https://graph.microsoft.com"},displayCall:authenticate,cacheLocation:"localStorage"},window.appConfig={siteHost:"melcherit.sharepoint.com",siteUrl:"/",documentLibrary:"<BikeDocuments>",list:"<BikeInventory>"},window.authContext=new AuthenticationContext(window.authConfig),window.authContext.isCallback(window.location.hash)){window.authContext.handleWindowCallback();var n=window.authContext.getLoginError();n?microsoftTeams.authentication.notifyFailure("Login Failed: "+n):window.authContext.acquireToken(window.authConfig.endpoints.graph,function(n,t){t?microsoftTeams.authentication.notifySuccess(t):microsoftTeams.authentication.notifyFailure("Acquring Graph Token Failed: "+n)})}else initPage()}catch(t){log("exception: "+t)}});